<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChainTrack - Habit Tracker</title> <!-- Simplified Title -->

    <!-- App Icons and Meta -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiBmaWxsPSIjNGY0NmU1Ij48cGF0aCBkPSJNMjU2IDhDMTE5IDggOCAxMTkgOCAyNTZzMTExIDI0OCAyNDggMjQ4IDI0OC0xMTEgMjQ4LTI0OFMzOTMgOCAyNTYgOHptMCA0NDhjLTExMC41IDAtMjAwLTg5LjUtMjAwLTIwMFMxNDUuNSA1NiAyNTYgNTZzMjAwIDg5LjUgMjAwIDIwMC04OS41IDIwMC0yMDAgMjAwem0xMTQuMy0yNzMuOWwtMjIuNi0yMi42Yy00LjctNC43LTEyLjMtNC43LTE3IDBMMjU2IDI4MC4zbC03NC43LTc0LjdjLTQuNy00LjctMTIuMy00LjctMTcgMGwtMjIuNiAyMi42Yy00LjcgNC43LTQuNyAxMi4zIDAgMTdMMjE2LjQgMzIwLjFsLTc0LjcgNzQuN2MtNC43IDQuNy00LjcgMTIuMyAwIDE3bDIyLjYgMjIuNmM0LjcgNC43IDEyLjMgNC43IDE3IDBsNzQuNy03NC43IDc0LjcgNzQuN2M0LjcgNC43IDEyLjMgNC43IDE3IDBsMjIuNi0yMi42YzQuNy00LjctNC43LTEyLjMgMC0xN0wyOTUuNiAzMjAuMWw3NC43LTc0LjdjNC43LTQuNyA0LjctMTIuMyAwLTE3eiIvPjwvcGF0aD48L3N2Zz4=">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ChainTrack">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4f46e5">
    <link rel="icon" sizes="192x192" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiBmaWxsPSIjNGY0NmU1Ij48cGF0aCBkPSJNMjU2IDhDMTE5IDggOCAxMTkgOCAyNTZzMTExIDI0OCAyNDggMjQ4IDI0OC0xMTEgMjQ4LTI0OFMzOTMgOCAyNTYgOHptMCA0NDhjLTExMC41IDAtMjAwLTg5LjUtMjAwLTIwMFMxNDUuNSA1NiAyNTYgNTZzMjAwIDg5LjUgMjAwIDIwMC04OS41IDIwMC0yMDAgMjAwem0xMTQuMy0yNzMuOWwtMjIuNi0yMi42Yy00LjctNC43LTEyLjMtNC43LTE3IDBMMjU2IDI4MC4zbC03NC43LTc0LjdjLTQuNy00LjctMTIuMy00LjctMTcgMGwtMjIuNiAyMi42Yy00LjcgNC43LTQuNyAxMi4zIDAgMTdMMjE2LjQgMzIwLjFsLTc0LjcgNzQuN2MtNC43IDQuNy00LjcgMTIuMyAwIDE3bDIyLjYgMjIuNmM0LjcgNC43IDEyLjMgNC43IDE3IDBsNzQuNy03NC43IDc0LjcgNzQuN2M0LjcgNC43IDEyLjMgNC43IDE3IDBsMjIuNi0yMi42YzQuNy00LjctNC43LTEyLjMgMC0xN0wyOTUuNiAzMjAuMWw3NC43LTc0LjdjNC43LTQuNyA0LjctMTIuMyAwLTE3eiIvPjwvcGF0aD48L3N2Zz4=">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com/3.3.3"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        /* Base Styles & Animations */
        :root {
            --color-indigo-500: #6366f1; /* Define CSS variables for dynamic colors */
            --color-green-500: #22c55e;
            --color-blue-500: #3b82f6;
            --color-pink-500: #ec4899;
            --color-purple-500: #a855f7;
            --color-yellow-500: #eab308;
            --color-teal-500: #14b8a6;
            --color-red-500: #ef4444;
            --color-orange-500: #f97316;
            --color-gray-600: #4b5563; /* Ensure gray is defined if used as fallback */
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .fade-in { animation: fadeIn 0.5s ease-in forwards; }
        .slide-up { animation: slideUp 0.4s ease-out forwards; }
        .streak-fire { animation: pulse 1.5s infinite ease-in-out; }

        /* Card Styling */
        .habit-card { transition: transform 0.2s ease-out, box-shadow 0.2s ease-out; }
        .habit-card:hover { transform: translateY(-3px); box-shadow: 0 6px 12px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .dark .habit-card:hover { box-shadow: 0 6px 12px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.3); }
        .habit-icon { width: 16px; height: 16px; margin-right: 8px; }
        .category-tag { font-size: 0.65rem; padding: 1px 6px; border-radius: 99px; line-height: 1; text-transform: uppercase; font-weight: 600; }

        /* Dark Mode */
        html.dark { color-scheme: dark; }
        .dark .dark\:bg-gray-950 { background-color: #0c1118; }
        .dark .dark\:bg-gray-900 { background-color: #161b22; }
        .dark .dark\:bg-gray-800 { background-color: #1f2937; }
        .dark .dark\:text-gray-100 { color: #e6edf3; }
        .dark .dark\:text-gray-300 { color: #bdc6cf; }
        .dark .dark\:border-gray-700 { border-color: #30363d; }
        .dark input:not([type="file"]), .dark select, .dark textarea {
            background-color: #0d1117 !important; /* Use important to override potential browser defaults */
            border-color: #30363d !important;
            color: #e6edf3 !important;
            border-radius: 6px;
        }
        /* Tailwind handles dark placeholder color with placeholder:text-gray-xxx */
        .dark input::placeholder, .dark textarea::placeholder { color: #768390; }
        /* Tailwind handles dark focus state with focus:ring-xxx focus:border-xxx */
        .dark input:focus, .dark select:focus, .dark textarea:focus { border-color: #58a6ff; box-shadow: 0 0 0 2px rgba(56, 139, 253, 0.3); outline: none; }

        /* Settings & Modals */
        .settings-panel { transition: transform 0.3s ease-out; transform: translateX(100%); }
        .settings-panel.open { transform: translateX(0); }
        .modal-overlay { background-color: rgba(10, 10, 20, 0.7); transition: opacity 0.3s ease; backdrop-filter: blur(2px); }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; transform: scale(0.95); opacity: 0; }
        .modal-overlay:not(.hidden) .modal-content { transform: scale(1); opacity: 1; }

        /* User Avatar */
        .user-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 3px solid #fff; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        .dark .user-avatar { border-color: #30363d; }

        /* Chain Links */
        .chain-link { transition: background-color 0.2s ease, transform 0.1s ease; }
        #edit-chain-container button:hover { transform: scale(1.1); }

        /* Toggle Switch */
        #dark-mode-toggle { transition: background-color 0.2s ease; }
        #dark-mode-toggle span:last-child { transition: transform 0.2s ease; }
        .dark #dark-mode-toggle { background-color: #6366f1; } /* Indigo when on */

        /* Undo Button */
        .undo-button { transition: all 0.3s ease; }
        .undo-button.visible { opacity: 1; transform: translateY(0); pointer-events: auto; }

         /* Chart Canvas */
         #streakComparisonChart { display: block; box-sizing: border-box; height: 300px; width: 100%; }
    </style>
</head>
<body class="min-h-full bg-gray-100 dark:bg-gray-950 text-gray-900 dark:text-gray-100 transition-colors duration-300 font-sans">
    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 flex items-center justify-center bg-gradient-to-br from-indigo-600 to-purple-700 dark:from-gray-900 dark:to-black z-50 transition-opacity duration-500">
        <div class="bg-white dark:bg-gray-900 p-8 rounded-xl shadow-2xl max-w-md w-full mx-4 transform transition-all duration-500 scale-95" id="login-container">
            <div class="text-center mb-8">
                 <div class="flex justify-center items-center mb-4 space-x-2">
                    <i class="fas fa-link text-5xl text-indigo-600 dark:text-indigo-400"></i>
                    <i class="fas fa-link text-5xl text-indigo-500 dark:text-indigo-500 opacity-75"></i>
                    <i class="fas fa-link text-5xl text-indigo-400 dark:text-indigo-600 opacity-50"></i>
                 </div>
                <h1 class="text-3xl font-bold text-indigo-600 dark:text-indigo-400 mb-2">ChainTrack</h1>
                <p class="text-gray-600 dark:text-gray-400">Build habits, forge your future.</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="pin-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Enter PIN</label>
                    <input type="password" id="pin-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-800 dark:border-gray-700 dark:text-white dark:placeholder-gray-500 text-center tracking-widest text-xl" placeholder="••••" maxlength="4" inputmode="numeric">
                </div>
                <button id="login-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 dark:bg-indigo-500 dark:hover:bg-indigo-600 text-white py-2.5 px-4 rounded-lg transition duration-300 transform hover:scale-105 text-lg font-semibold flex items-center justify-center space-x-2">
                    <i class="fas fa-unlock-alt"></i>
                    <span>Unlock App</span>
                </button>
            </div>
            <div id="pin-error" class="mt-4 text-red-500 dark:text-red-400 text-center hidden text-sm">Incorrect PIN. Try again.</div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden min-h-screen relative flex flex-col">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-900 shadow-sm sticky top-0 z-30">
            <div class="container mx-auto px-4 py-3">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-link text-indigo-600 dark:text-indigo-400 text-2xl"></i>
                        <h1 class="text-xl font-bold text-gray-800 dark:text-gray-100">ChainTrack</h1>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button id="settings-btn" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition" title="Settings">
                            <i class="fas fa-cog text-lg"></i>
                        </button>
                        <button id="theme-toggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition" title="Toggle Theme">
                            <i class="fas fa-moon text-lg text-gray-600 dark:text-yellow-300 hidden dark:inline-block"></i>
                            <i class="fas fa-sun text-lg text-gray-600 dark:text-gray-100 inline-block dark:hidden"></i>
                        </button>
                        <button id="logout-btn" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition" title="Logout">
                            <i class="fas fa-sign-out-alt text-lg"></i>
                        </button>
                    </div>
                </div>
                 <!-- Motivational Quote -->
                 <div id="quote-container" class="text-center text-xs italic text-gray-500 dark:text-gray-500 pt-2 mt-2 border-t border-gray-200 dark:border-gray-700 opacity-0">
                    <p id="quote-text"></p>
                    <p id="quote-author" class="font-semibold"></p>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-grow container mx-auto px-4 py-6">
            <!-- View Selection & Container -->
            <div class="bg-white dark:bg-gray-900 rounded-xl shadow-md p-4 md:p-6 mb-6">
                 <!-- Top Navigation -->
                 <div class="flex flex-wrap justify-center md:justify-start items-center gap-2 mb-6 border-b border-gray-200 dark:border-gray-700 pb-4">
                     <button id="user1-btn" class="px-3 py-1.5 text-sm font-medium rounded-lg transition flex items-center space-x-2">
                         <img id="btn-user1-avatar" class="w-5 h-5 rounded-full object-cover inline-block" src="" alt="U1">
                         <span id="btn-user1-name">User 1</span>
                     </button>
                     <button id="user2-btn" class="px-3 py-1.5 text-sm font-medium rounded-lg transition flex items-center space-x-2">
                         <img id="btn-user2-avatar" class="w-5 h-5 rounded-full object-cover inline-block" src="" alt="U2">
                         <span id="btn-user2-name">User 2</span>
                     </button>
                     <button id="compare-btn" class="px-3 py-1.5 text-sm font-medium rounded-lg transition flex items-center space-x-2">
                         <i class="fas fa-chart-bar w-4 text-center"></i>
                         <span>Compare</span>
                     </button>
                 </div>

                <!-- View Container -->
                 <div id="view-container">
                    <!-- Dashboard View -->
                    <div id="dashboard-view" class="hidden">
                        <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-100 mb-6 text-center">Comparison Dashboard</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <!-- User 1 Stats Card -->
                            <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                                <div class="flex items-center space-x-3 mb-4">
                                    <img id="dashboard-user1-avatar" class="user-avatar w-10 h-10" src="" alt="U1">
                                    <h4 id="dashboard-user1-name" class="font-semibold text-lg text-indigo-700 dark:text-indigo-400">User 1 Stats</h4>
                                </div>
                                <div id="user1-stats" class="space-y-1.5 text-sm"></div>
                            </div>
                            <!-- User 2 Stats Card -->
                            <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                                <div class="flex items-center space-x-3 mb-4">
                                    <img id="dashboard-user2-avatar" class="user-avatar w-10 h-10" src="" alt="U2">
                                    <h4 id="dashboard-user2-name" class="font-semibold text-lg text-green-700 dark:text-green-400">User 2 Stats</h4>
                                </div>
                                <div id="user2-stats" class="space-y-1.5 text-sm"></div>
                            </div>
                        </div>
                        <!-- Comparison Chart -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-700 dark:text-gray-100 mb-4 text-center">Current Streak Comparison</h4>
                            <div id="comparison-chart-container" class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 min-h-[320px]">
                                 <canvas id="streakComparisonChart"></canvas>
                                 <p id="no-comparison-data" class="text-center text-gray-500 dark:text-gray-400 hidden pt-16">No shared habits with current streaks > 0 to compare.</p>
                            </div>
                        </div>
                    </div>

                    <!-- User Habit View -->
                    <div id="user-view" class="hidden">
                        <!-- User Info Header -->
                        <div class="flex flex-col sm:flex-row items-center justify-between mb-6 gap-4">
                            <div class="flex items-center space-x-3">
                                <img id="current-user-avatar" class="user-avatar" src="" alt="Current User">
                                <div>
                                    <h3 id="current-user" class="text-xl font-semibold text-indigo-700 dark:text-indigo-400"></h3>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">Overall Best Streak:
                                        <span id="current-streak" class="font-bold text-sm flex items-center text-gray-700 dark:text-gray-200">
                                            <span id="streak-days">0</span> days
                                            <i id="streak-icon" class="fas fa-star text-yellow-400 ml-1 text-xs hidden"></i>
                                        </span>
                                    </p>
                                </div>
                            </div>
                            <button id="add-habit-btn" class="w-full sm:w-auto px-3 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition flex items-center justify-center space-x-1.5 text-sm font-medium shadow hover:shadow-md">
                                <i class="fas fa-plus"></i>
                                <span>Add Habit</span>
                            </button>
                        </div>

                        <!-- Add Habit Form (Inline) -->
                        <div id="add-habit-form" class="hidden mb-6 bg-indigo-50 dark:bg-gray-800 p-4 rounded-lg shadow-inner border border-indigo-100 dark:border-gray-700">
                            <h4 class="text-md font-semibold mb-3 text-indigo-800 dark:text-indigo-300">Add New Habit</h4>
                            <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
                                <input type="text" id="new-habit-name" placeholder="Enter habit name (e.g., Morning Run)" class="flex-grow px-3 py-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <input type="text" id="new-habit-category" list="category-suggestions" placeholder="Category (optional)" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white sm:w-36">
                                <datalist id="category-suggestions">
                                    <!-- Options populated by JS -->
                                </datalist>
                                <div class="flex gap-2 mt-2 sm:mt-0">
                                    <button id="save-habit-btn" class="flex-1 sm:flex-none px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition text-sm font-medium">Save</button>
                                    <button id="cancel-habit-btn" class="flex-1 sm:flex-none px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg transition dark:bg-gray-600 dark:text-white dark:hover:bg-gray-500 text-sm font-medium">Cancel</button>
                                </div>
                            </div>
                        </div>

                         <!-- Filters -->
                         <div class="mb-4">
                             <label for="category-filter" class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Filter by Category</label>
                             <select id="category-filter" class="w-full md:w-auto px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-800 dark:border-gray-700">
                                 <option value="all">All Categories</option>
                                 <!-- Categories populated by JS -->
                             </select>
                         </div>

                        <!-- Habits List -->
                        <div id="habits-container" class="space-y-4">
                            <!-- Habit cards dynamically populated -->
                        </div>
                         <div id="no-habits-message" class="hidden text-center py-10">
                             <i class="fas fa-list-alt text-gray-400 text-5xl mb-4"></i>
                             <p class="text-gray-500 dark:text-gray-400">No habits tracked yet.</p>
                             <p class="text-gray-500 dark:text-gray-400">Click "Add Habit" to get started!</p>
                         </div>
                         <div id="no-filtered-habits-message" class="hidden text-center py-10">
                             <i class="fas fa-filter text-gray-400 text-5xl mb-4"></i>
                             <p class="text-gray-500 dark:text-gray-400">No habits match the selected category.</p>
                         </div>
                    </div>
                    <!-- Calendar View Div Removed -->
                 </div>
            </div>
        </main>

        <!-- Settings Panel -->
        <aside id="settings-panel" class="settings-panel fixed top-0 right-0 w-full max-w-sm h-full bg-white dark:bg-gray-900 shadow-lg z-40 overflow-y-auto p-6 border-l border-gray-200 dark:border-gray-700">
            <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-100">Settings</h2>
                <button id="close-settings-btn" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="space-y-8">
                <!-- User Profiles -->
                <section>
                    <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-100 mb-4 border-b border-gray-200 dark:border-gray-700 pb-2">User Profiles</h3>
                    <div class="space-y-5">
                        <div>
                            <label for="user1-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">User 1 Name</label>
                            <div class="flex items-center space-x-2">
                                <input type="text" id="user1-name" class="flex-grow px-3 py-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-sm dark:bg-gray-800 dark:border-gray-700">
                                <input type="file" id="user1-avatar" accept="image/*" class="hidden">
                                <button id="user1-avatar-btn" class="p-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition text-sm" title="Upload User 1 Avatar">
                                    <i class="fas fa-image"></i>
                                </button>
                            </div>
                             <img id="settings-user1-avatar-preview" class="mt-2 w-10 h-10 rounded-full object-cover bg-gray-200 dark:bg-gray-700" src="" alt="U1 Preview">
                        </div>
                         <div>
                            <label for="user2-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">User 2 Name</label>
                            <div class="flex items-center space-x-2">
                                <input type="text" id="user2-name" class="flex-grow px-3 py-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-sm dark:bg-gray-800 dark:border-gray-700">
                                <input type="file" id="user2-avatar" accept="image/*" class="hidden">
                                <button id="user2-avatar-btn" class="p-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition text-sm" title="Upload User 2 Avatar">
                                    <i class="fas fa-image"></i>
                                </button>
                            </div>
                             <img id="settings-user2-avatar-preview" class="mt-2 w-10 h-10 rounded-full object-cover bg-gray-200 dark:bg-gray-700" src="" alt="U2 Preview">
                        </div>
                        <button id="save-names-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-lg transition text-sm font-medium">
                            Save User Profiles
                        </button>
                    </div>
                </section>

                 <!-- Habit Management -->
                 <section>
                    <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-100 mb-4 border-b border-gray-200 dark:border-gray-700 pb-2">Manage Habits</h3>
                    <div class="space-y-3">
                        <button id="edit-habits-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-black py-2 px-4 rounded-lg transition text-sm font-medium flex items-center justify-center space-x-2"> <!-- Text black for yellow -->
                            <i class="fas fa-edit"></i><span>Edit / Delete Habits</span>
                        </button>
                        <button id="reset-all-btn" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg transition text-sm font-medium flex items-center justify-center space-x-2">
                            <i class="fas fa-undo"></i><span>Reset All Counters & Notes</span>
                        </button>
                    </div>
                </section>

                <!-- App Settings -->
                 <section>
                    <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-100 mb-4 border-b border-gray-200 dark:border-gray-700 pb-2">App Settings</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Dark Mode</span>
                            <button id="dark-mode-toggle" class="relative inline-flex items-center h-6 rounded-full w-11 bg-gray-200 dark:bg-gray-600">
                                <span class="sr-only">Toggle Dark Mode</span>
                                <span class="inline-block w-4 h-4 transform bg-white dark:bg-gray-300 rounded-full transition"></span>
                            </button>
                        </div>
                        <button id="reset-pin-btn" class="w-full bg-purple-500 hover:bg-purple-600 text-white py-2 px-4 rounded-lg transition text-sm font-medium flex items-center justify-center space-x-2">
                            <i class="fas fa-key"></i><span>Reset App PIN</span>
                        </button>
                    </div>
                </section>
                <!-- Achievements Section Removed -->
            </div>
        </aside>

         <!-- Modals Container -->
         <div id="modals-container">
            <!-- Edit Habits Modal -->
            <div id="edit-habits-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden modal-overlay p-4">
                 <div class="modal-content bg-white dark:bg-gray-900 rounded-xl shadow-2xl p-6 max-w-lg w-full mx-auto max-h-[80vh] flex flex-col">
                    <div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-200 dark:border-gray-700">
                         <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-100">Edit Habits</h2>
                         <button id="cancel-edit-habits-btn" class="p-1 rounded-full text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700 transition">
                             <i class="fas fa-times text-xl"></i>
                         </button>
                    </div>
                    <div class="flex-grow overflow-y-auto pr-2 space-y-4">
                        <div>
                            <label for="edit-habits-user-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Select User</label>
                            <select id="edit-habits-user-select" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                                <option value="user1">User 1</option>
                                <option value="user2">User 2</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Select Habit to Edit</label>
                            <div id="edit-habits-list" class="space-y-2">
                                <!-- Habit list populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit Single Habit Modal -->
            <div id="edit-habit-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden modal-overlay p-4">
                <div class="modal-content bg-white dark:bg-gray-900 rounded-xl shadow-2xl p-6 max-w-lg w-full mx-auto max-h-[90vh] flex flex-col">
                     <!-- Header -->
                     <div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-200 dark:border-gray-700">
                         <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-100">Edit Habit</h2>
                         <button id="cancel-edit-habit-btn" class="p-1 rounded-full text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700 transition">
                             <i class="fas fa-times text-xl"></i>
                         </button>
                     </div>
                     <!-- Content -->
                    <div class="flex-grow overflow-y-auto pr-2 space-y-4">
                        <div>
                            <label for="edit-habit-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Habit Name</label>
                            <input type="text" id="edit-habit-name" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-sm dark:bg-gray-800">
                        </div>
                        <div>
                            <label for="edit-habit-category" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Category</label>
                            <input type="text" id="edit-habit-category" list="category-suggestions" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-sm dark:bg-gray-800" placeholder="e.g., Health, Work">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Edit Streak Chain (Click day to toggle)</label>
                             <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">Green = Completed, Gray = Missed</p>
                            <div id="edit-chain-container" class="flex flex-wrap gap-1.5 p-2 bg-gray-100 dark:bg-gray-800 rounded-md max-h-48 overflow-y-auto border border-gray-200 dark:border-gray-700">
                                <!-- Chain days populated by JS -->
                            </div>
                        </div>
                        <div>
                             <label for="edit-habit-note" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Note for Last Entry</label>
                             <textarea id="edit-habit-note" rows="2" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-sm dark:bg-gray-800" placeholder="Add an optional note..."></textarea>
                             <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Linked to the most recent day in the chain.</p>
                         </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Actions</label>
                            <div class="flex flex-wrap gap-2">
                                 <button id="reset-habit-btn" class="px-3 py-1.5 bg-yellow-500 hover:bg-yellow-600 text-black rounded-lg transition text-xs font-medium flex items-center space-x-1">
                                    <i class="fas fa-undo"></i><span>Reset Chain</span>
                                </button>
                                <button id="delete-habit-btn" class="px-3 py-1.5 bg-red-500 hover:bg-red-600 text-white rounded-lg transition text-xs font-medium flex items-center space-x-1">
                                    <i class="fas fa-trash-alt"></i><span>Delete Habit</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- Footer -->
                    <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200 dark:border-gray-700 mt-4">
                        <button id="save-edit-habit-btn" class="px-5 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition text-sm font-medium flex items-center space-x-1.5">
                            <i class="fas fa-save"></i><span>Save Changes</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Reset Confirmation Modal -->
             <div id="reset-confirm-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden modal-overlay p-4">
                <div class="modal-content bg-white dark:bg-gray-900 rounded-xl shadow-2xl p-6 max-w-md w-full mx-auto">
                    <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">Confirm Reset</h2>
                    <p class="text-gray-600 dark:text-gray-300 mb-6 text-sm">Are you sure you want to reset the counters (streak chains), best streaks, and notes for <span class="font-bold">all habits</span> for <span class="font-bold">both users</span>? This action cannot be undone.</p>
                    <div class="flex justify-end space-x-3">
                        <button id="cancel-reset-btn" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg transition dark:bg-gray-600 dark:text-white dark:hover:bg-gray-500 text-sm font-medium">
                            Cancel
                        </button>
                        <button id="confirm-reset-btn" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition text-sm font-medium">
                            Yes, Reset All
                        </button>
                    </div>
                </div>
            </div>

            <!-- Delete Habit Confirmation Modal -->
             <div id="delete-confirm-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden modal-overlay p-4">
                 <div class="modal-content bg-white dark:bg-gray-900 rounded-xl shadow-2xl p-6 max-w-md w-full mx-auto">
                    <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">Confirm Deletion</h2>
                    <p class="text-gray-600 dark:text-gray-300 mb-6 text-sm">Are you sure you want to delete the habit "<span id="delete-habit-name-confirm" class="font-bold"></span>"? This will also remove associated notes and cannot be undone.</p>
                    <div class="flex justify-end space-x-3">
                        <button id="cancel-delete-btn" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg transition dark:bg-gray-600 dark:text-white dark:hover:bg-gray-500 text-sm font-medium">
                            Cancel
                        </button>
                        <button id="confirm-delete-btn" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition text-sm font-medium">
                            Delete Habit
                        </button>
                    </div>
                </div>
            </div>

            <!-- Reset PIN Modal -->
             <div id="reset-pin-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden modal-overlay p-4">
                <div class="modal-content bg-white dark:bg-gray-900 rounded-xl shadow-2xl p-6 max-w-md w-full mx-auto">
                    <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">Reset App PIN</h2>
                    <div class="space-y-3">
                        <div>
                            <label for="current-pin" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Current PIN</label>
                            <input type="password" id="current-pin" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-sm tracking-widest dark:bg-gray-800 dark:border-gray-700" placeholder="••••" maxlength="4" inputmode="numeric">
                        </div>
                        <div>
                            <label for="new-pin" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">New PIN</label>
                            <input type="password" id="new-pin" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-sm tracking-widest dark:bg-gray-800 dark:border-gray-700" placeholder="••••" maxlength="4" inputmode="numeric">
                        </div>
                        <div>
                            <label for="confirm-new-pin" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Confirm New PIN</label>
                            <input type="password" id="confirm-new-pin" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-sm tracking-widest dark:bg-gray-800 dark:border-gray-700" placeholder="••••" maxlength="4" inputmode="numeric">
                        </div>
                        <div id="reset-pin-error" class="text-red-500 dark:text-red-400 text-sm hidden"></div>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200 dark:border-gray-700 mt-4">
                        <button id="cancel-reset-pin-btn" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg transition dark:bg-gray-600 dark:text-white dark:hover:bg-gray-500 text-sm font-medium">
                            Cancel
                        </button>
                        <button id="confirm-reset-pin-btn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition text-sm font-medium">
                            Change PIN
                        </button>
                    </div>
                </div>
            </div>

         </div> <!-- End Modals Container -->

        <!-- Global Notification Area -->
        <div id="notification-area" class="fixed bottom-4 right-4 z-[100] space-y-2 w-full max-w-xs sm:max-w-sm"></div>

    </div> <!-- End App Container -->

    <script>
        // --- App State ---
        const state = {
            currentUser: 'user1',
            currentView: 'user', // 'user', 'compare'
            habits: { user1: [], user2: [] }, // Structure: { id, name, chain: [bool], category, bestStreak }
            userNames: { user1: 'User 1', user2: 'User 2' },
            userAvatars: { user1: '', user2: '' },
            notes: {}, // { 'userId-habitId-YYYY-MM-DD': 'Note content' }
            categories: ['General'], // Start with General, loaded/updated from habits
            theme: 'light',
            lastTrackedDate: {}, // { 'userId-habitId': 'YYYY-MM-DD' }
            appPin: '9966',
            pendingUndo: null, // { userId, habitId }
        };

        const DEFAULT_AVATAR = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzkwYTBhZSI+PHBhdGggZD0iTTEyIDEyYzIuMjEgMCA0LTEuNzkgNC00cy0xLjc5LTQtNC00LTQgMS43OS00IDRzMS43OSA0IDQgNHptMCAyYy0yLjY3IDAtOCAxLjM0LTggNHYyaDE2di0yYzAtMi42Ni01LjMzLTQtOC00eiIvPjwvc3ZnPg==';

        const motivationalQuotes = [
            { text: "The secret of getting ahead is getting started.", author: "Mark Twain" },
            { text: "It does not matter how slowly you go as long as you do not stop.", author: "Confucius" },
            { text: "We are what we repeatedly do. Excellence, then, is not an act, but a habit.", author: "Aristotle" },
            { text: "Your habits will determine your future.", author: "Jack Canfield" },
            { text: "Motivation is what gets you started. Habit is what keeps you going.", author: "Jim Ryun" },
            { text: "Success is the sum of small efforts, repeated day in and day out.", author: "Robert Collier" },
            { text: "The chains of habit are too weak to be felt until they are too strong to be broken.", author: "Samuel Johnson" },
            { text: "Consistency is the key to achieving and maintaining momentum.", author: "Darren Hardy" }
        ];

        // --- DOM Element Access ---
        const getEl = (id) => document.getElementById(id);
        const queryEl = (selector) => document.querySelector(selector);
        const queryAllEl = (selector) => document.querySelectorAll(selector);

        let comparisonChart = null;
        let undoTimeoutId = null;

        // --- Utility Functions ---
        function stringToColorClass(str) {
             let hash = 0;
             if (!str || str.length === 0) return 'gray';
             for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
             const colors = ['indigo', 'green', 'blue', 'pink', 'purple', 'yellow', 'teal', 'red', 'orange'];
             return colors[Math.abs(hash) % colors.length];
        }
        function getHabitIcon(habitName) {
             if (!habitName) return 'fa-link';
             const nameLower = habitName.toLowerCase();
             if (nameLower.includes('run') || nameLower.includes('walk') || nameLower.includes('exercise') || nameLower.includes('gym')) return 'fa-person-running';
             if (nameLower.includes('read') || nameLower.includes('book')) return 'fa-book-open';
             if (nameLower.includes('meditate') || nameLower.includes('mindful') || nameLower.includes('breath')) return 'fa-brain';
             if (nameLower.includes('water') || nameLower.includes('drink')) return 'fa-glass-water';
             if (nameLower.includes('journal') || nameLower.includes('write')) return 'fa-pencil-alt';
             if (nameLower.includes('sleep') || nameLower.includes('wake')) return 'fa-bed';
             if (nameLower.includes('code') || nameLower.includes('study') || nameLower.includes('learn')) return 'fa-laptop-code';
             if (nameLower.includes('clean') || nameLower.includes('tidy')) return 'fa-broom';
             if (nameLower.includes('plan') || nameLower.includes('review')) return 'fa-calendar-check';
             return 'fa-link';
        }
        function calculateStreak(chain) {
             if (!Array.isArray(chain)) return 0; let cs = 0; for (let i = chain.length - 1; i >= 0; i--) { if (chain[i]) cs++; else break; } return cs;
        }
        function calculateAndUpdateBestStreak(habit) {
            if (!habit || !Array.isArray(habit.chain)) return 0; let bs = 0; let cs = 0;
            habit.chain.forEach(day => { if (day) cs++; else { bs = Math.max(bs, cs); cs = 0; } });
            bs = Math.max(bs, cs); habit.bestStreak = Math.max(habit.bestStreak || 0, bs); return habit.bestStreak;
        }
        function calculateCompletionRate(chain) { if (!Array.isArray(chain) || chain.length === 0) return 0; return Math.round((chain.filter(d => d).length / chain.length) * 100); }
        function getTodayDateString() { return new Date().toISOString().split('T')[0]; }
        function hasTrackedToday(userId, habitId) { return state.lastTrackedDate[`${userId}-${habitId}`] === getTodayDateString(); }

        // --- State Management ---
        function loadState() {
            state.theme = localStorage.getItem('theme') || 'light';
            state.appPin = localStorage.getItem('appPin') || '9966'; // Load PIN or default
            try { state.userNames = JSON.parse(localStorage.getItem('userNames') || JSON.stringify(state.userNames)); } catch (e) { console.error("Error loading names", e); }
            try { state.userAvatars = JSON.parse(localStorage.getItem('userAvatars') || JSON.stringify(state.userAvatars)); } catch (e) { console.error("Error loading avatars", e); }
            try { state.lastTrackedDate = JSON.parse(localStorage.getItem('lastTrackedDate') || '{}'); } catch (e) { console.error("Error loading dates", e); state.lastTrackedDate = {}; }
            try { state.notes = JSON.parse(localStorage.getItem('notes') || '{}'); } catch (e) { console.error("Error loading notes", e); state.notes = {}; }

            try {
                const storedHabits = JSON.parse(localStorage.getItem('habits') || '{}');
                // Ensure default properties exist, recalculate best streak if needed
                const processHabit = (h) => ({ ...h, category: h.category || 'General', bestStreak: h.bestStreak || calculateAndUpdateBestStreak(h) });
                state.habits.user1 = (storedHabits.user1 || []).map(processHabit);
                state.habits.user2 = (storedHabits.user2 || []).map(processHabit);
                updateCategoriesFromHabits();
            } catch (e) {
                console.error("Failed to load habits:", e);
                state.habits = { user1: [], user2: [] }; // Reset if invalid
            }
        }

        function saveState() {
            try {
                localStorage.setItem('theme', state.theme);
                localStorage.setItem('appPin', state.appPin);
                localStorage.setItem('userNames', JSON.stringify(state.userNames));
                localStorage.setItem('userAvatars', JSON.stringify(state.userAvatars));
                localStorage.setItem('habits', JSON.stringify(state.habits));
                localStorage.setItem('lastTrackedDate', JSON.stringify(state.lastTrackedDate));
                localStorage.setItem('notes', JSON.stringify(state.notes));
                // console.log("State saved.");
            } catch (error) {
                console.error("Error saving state to localStorage:", error);
                showNotification("Error saving data. Storage might be full.", "error");
            }
        }

        function updateCategoriesFromHabits() {
             const categoriesInUse = new Set(['General']);
             [...(state.habits.user1 || []), ...(state.habits.user2 || [])].forEach(h => { if (h && h.category) categoriesInUse.add(h.category); });
             state.categories = Array.from(categoriesInUse).sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));
         }

        // --- UI Update Functions ---
        function applyTheme() {
             document.documentElement.classList.toggle('dark', state.theme === 'dark');
             const toggle = getEl('dark-mode-toggle');
             toggle.classList.toggle('bg-indigo-600', state.theme === 'dark');
             toggle.classList.toggle('bg-gray-200', state.theme === 'light');
             toggle.querySelector('span:last-child').classList.toggle('translate-x-5', state.theme === 'dark');
             if (comparisonChart) renderDashboardChart(); // Update chart theme
         }
        function displayQuote() {
             const quote = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
             getEl('quote-text').textContent = `"${quote.text}"`; getEl('quote-author').textContent = `- ${quote.author}`;
             getEl('quote-container').style.opacity = 1;
        }
        function updateAvatarDisplays() {
            const av1 = state.userAvatars.user1 || DEFAULT_AVATAR, av2 = state.userAvatars.user2 || DEFAULT_AVATAR;
            getEl('btn-user1-avatar').src = av1; getEl('btn-user2-avatar').src = av2;
            getEl('dashboard-user1-avatar').src = av1; getEl('dashboard-user2-avatar').src = av2;
            getEl('settings-user1-avatar-preview').src = av1; getEl('settings-user2-avatar-preview').src = av2;
            getEl('current-user-avatar').src = state.currentUser === 'user1' ? av1 : av2;
        }
        function updateUserDisplayNames() {
            const n1 = state.userNames.user1, n2 = state.userNames.user2;
            getEl('btn-user1-name').textContent = n1; getEl('btn-user2-name').textContent = n2;
            getEl('dashboard-user1-name').textContent = n1 + " Stats"; getEl('dashboard-user2-name').textContent = n2 + " Stats";
            getEl('user1-name').value = n1; getEl('user2-name').value = n2;
            try { getEl('edit-habits-user-select').options[0].text = n1; getEl('edit-habits-user-select').options[1].text = n2; } catch(e) {} // Ignore if element not ready
            getEl('current-user').textContent = state.userNames[state.currentUser];
        }
        function updateViewSpecificStyles() {
             const buttons = [getEl('user1-btn'), getEl('user2-btn'), getEl('compare-btn')];
             const activeCls = 'bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300 font-semibold ring-1 ring-indigo-300 dark:ring-indigo-600';
             const inactiveCls = 'bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300';
             const compareActiveCls = activeCls.split(' ').map(c => c.replace('indigo', 'purple'));

             buttons.forEach(btn => btn.className = btn.className.replace(activeCls, '').replace(inactiveCls, '').replace(compareActiveCls.join(' '), '').trim());

             if (state.currentView === 'user') {
                 getEl(state.currentUser === 'user1' ? 'user1-btn' : 'user2-btn').classList.add(...activeCls.split(' '));
                 getEl(state.currentUser === 'user1' ? 'user2-btn' : 'user1-btn').classList.add(...inactiveCls.split(' '));
                 getEl('compare-btn').classList.add(...inactiveCls.split(' '));
             } else if (state.currentView === 'compare') {
                 getEl('user1-btn').classList.add(...inactiveCls.split(' ')); getEl('user2-btn').classList.add(...inactiveCls.split(' '));
                 getEl('compare-btn').classList.add(...compareActiveCls);
             }

             getEl('user-view').classList.toggle('hidden', state.currentView !== 'user');
             getEl('dashboard-view').classList.toggle('hidden', state.currentView !== 'compare');

             if (state.currentView === 'user') renderHabits();
             else if (state.currentView === 'compare') renderDashboard();
         }
        function updateOverallStreakDisplay() {
             const userHabits = state.habits[state.currentUser] || [];
             if (userHabits.length === 0) { getEl('streak-days').textContent = '0'; getEl('streak-icon').classList.add('hidden'); return; }
             const bestStreaks = userHabits.map(h => h.bestStreak || 0);
             const overallMaxStreak = Math.max(0, ...bestStreaks);
             getEl('streak-days').textContent = overallMaxStreak;
             getEl('streak-icon').classList.toggle('hidden', overallMaxStreak <= 7);
        }
        function populateCategoryFilterAndSuggestions() {
             const select = getEl('category-filter'); const datalist = getEl('category-suggestions');
             const currentVal = select.value; select.innerHTML = '<option value="all">All Categories</option>'; datalist.innerHTML = '';
             state.categories.forEach(cat => { const opt = document.createElement('option'); opt.value = cat; opt.textContent = cat; select.appendChild(opt.cloneNode(true)); datalist.appendChild(opt); });
             select.value = state.categories.includes(currentVal) ? currentVal : 'all'; // Keep selection if valid
        }

        // --- Habit Rendering ---
        function renderHabits() {
            const container = getEl('habits-container');
            const noHabitsMsg = getEl('no-habits-message'); const noFilteredMsg = getEl('no-filtered-habits-message');
            container.innerHTML = ''; clearPendingUndo();

            const userHabits = state.habits[state.currentUser] || [];
            const selectedCategory = getEl('category-filter').value;
            const filteredHabits = (selectedCategory === 'all') ? userHabits : userHabits.filter(h => h.category === selectedCategory);

            noHabitsMsg.classList.toggle('hidden', userHabits.length > 0);
            noFilteredMsg.classList.toggle('hidden', selectedCategory === 'all' || filteredHabits.length > 0 || userHabits.length === 0);

            if (filteredHabits.length > 0) {
                filteredHabits.forEach((habit, index) => {
                    if (!habit || !habit.id) return;

                    const card = document.createElement('div');
                    card.className = 'relative habit-card bg-white dark:bg-gray-900 rounded-lg shadow-sm p-4 slide-up border-l-4 border-transparent';
                    card.style.animationDelay = `${index * 0.05}s`; card.dataset.habitId = habit.id; card.dataset.userId = state.currentUser;

                    const currentStreak = calculateStreak(habit.chain);
                    const bestStreak = habit.bestStreak || 0;
                    const isTracked = hasTrackedToday(state.currentUser, habit.id);
                    const rate = calculateCompletionRate(habit.chain);
                    const chain = habit.chain || []; const len = chain.length;
                    const colorName = stringToColorClass(habit.category || 'General'); const colorVar = `--color-${colorName}-500`;
                    card.style.borderLeftColor = `var(${colorVar}, #6b7280)`;
                    const icon = getHabitIcon(habit.name);

                    let note = null; let noteTitle = '';
                    if (len > 0 && chain[len - 1]) {
                         const dateStr = getTodayDateString(); // Note tied to today if last day completed
                         const noteKey = `${state.currentUser}-${habit.id}-${dateStr}`;
                         note = state.notes[noteKey]; noteTitle = note ? `Note for today: ${note.substring(0, 50)}...` : '';
                    }

                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center flex-wrap gap-x-2">
                                <i class="fas ${icon} habit-icon" style="color: var(${colorVar})"></i>
                                <h3 class="font-semibold text-lg text-gray-800 dark:text-gray-100">${habit.name}</h3>
                                ${note ? `<i class="fas fa-sticky-note text-xs text-yellow-400 cursor-help" title="${noteTitle}"></i>` : ''}
                            </div>
                            <button data-habit-id="${habit.id}" class="track-btn shrink-0 px-3 py-1.5 text-white rounded-lg transition text-xs font-medium flex items-center space-x-1 shadow disabled:opacity-70 disabled:cursor-not-allowed disabled:shadow-none" ${isTracked ? 'disabled' : ''} style="background-color: var(${colorVar});">
                                <i class="fas ${isTracked ? 'fa-check' : 'fa-plus'} text-xs"></i><span>${isTracked ? 'Done!' : 'Track'}</span>
                            </button>
                        </div>
                        <div class="mb-3"><span class="category-tag text-white" style="background-color: var(${colorVar})">${habit.category || 'General'}</span></div>
                        <div class="flex justify-between items-center text-xs text-gray-500 dark:text-gray-400 mb-3">
                            <span>Current: <strong class="text-gray-700 dark:text-gray-200 ${currentStreak > 7 ? 'text-orange-500' : ''}">${currentStreak}</strong> ${currentStreak > 7 ? '<i class="fas fa-fire text-orange-500 streak-fire text-xs"></i>' : ''}</span>
                            <span>Best: <strong class="text-gray-700 dark:text-gray-200">${bestStreak} <i class="fas fa-star text-yellow-400 text-xs"></i></strong></span>
                            <span>Rate: <strong class="text-gray-700 dark:text-gray-200">${rate}%</strong></span>
                        </div>
                        <div class="chain-container flex flex-wrap gap-1">
                             ${len > 0 ? chain.slice(-28).map((day, i) => `<div class="chain-link w-5 h-5 rounded transition ${day ? '' : 'bg-gray-200 dark:bg-gray-700'}" style="background-color: ${day ? `var(${colorVar})` : ''}" title="Day ${Math.max(0, len - 28) + i + 1}"></div>`).join('') : '<span class="text-xs text-gray-400">No history yet.</span>'}
                        </div>
                        <button data-habit-id="${habit.id}" class="undo-button absolute bottom-2 right-2 px-2 py-1 bg-yellow-500 hover:bg-yellow-600 text-black rounded text-xs opacity-0 transition duration-300 ease-in-out pointer-events-none transform translate-y-2"> <i class="fas fa-undo mr-1"></i> Undo </button>
                    `;
                    container.appendChild(card);
                });
            }
            updateOverallStreakDisplay();
        }

        // --- Dashboard Rendering ---
        function renderDashboardStats(userId) {
            const userHabits = state.habits[userId] || []; const statsEl = getEl(userId === 'user1' ? 'user1-stats' : 'user2-stats');
            const curStreaks = userHabits.map(h => calculateStreak(h.chain)); const maxCur = Math.max(0, ...curStreaks);
            const bestStreaks = userHabits.map(h => h.bestStreak || 0); const maxBest = Math.max(0, ...bestStreaks);
            const rates = userHabits.map(h => calculateCompletionRate(h.chain)); const avgRate = rates.length ? Math.round(rates.reduce((s, r) => s + r, 0) / rates.length) : 0;
            const totalDone = userHabits.reduce((s, h) => s + (h.chain || []).filter(d => d).length, 0);
            const totalTracked = userHabits.reduce((s, h) => s + (h.chain || []).length, 0);
            statsEl.innerHTML = `
                <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">Habits:</span><strong class="dark:text-gray-100">${userHabits.length}</strong></div>
                <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">Longest Current:</span><strong class="dark:text-gray-100">${maxCur} ${maxCur > 7 ? '<i class="fas fa-fire text-orange-500 streak-fire"></i>' : ''}</strong></div>
                <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">Longest Ever:</span><strong class="dark:text-gray-100">${maxBest} <i class="fas fa-star text-yellow-400"></i></strong></div>
                <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">Avg Completion:</span><strong class="dark:text-gray-100">${avgRate}%</strong></div>
                <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">Days Completed:</span><strong class="dark:text-gray-100">${totalDone}</strong></div>
                <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">Days Tracked:</span><strong class="dark:text-gray-100">${totalTracked}</strong></div>`;
        }
        function renderDashboardChart() {
             const user1Habits = state.habits.user1 || []; const user2Habits = state.habits.user2 || [];
             const shared = []; const names = new Set([...user1Habits.map(h => h.name), ...user2Habits.map(h => h.name)]);
             names.forEach(name => { const h1 = user1Habits.find(h => h.name === name), h2 = user2Habits.find(h => h.name === name); const s1 = h1 ? calculateStreak(h1.chain) : 0, s2 = h2 ? calculateStreak(h2.chain) : 0; if (s1 > 0 || s2 > 0) shared.push({ name, s1, s2 }); });
             const canvas = getEl('streakComparisonChart'); const msg = getEl('no-comparison-data'); const ctx = canvas.getContext('2d');
             if (comparisonChart) { comparisonChart.destroy(); comparisonChart = null; }
             msg.classList.toggle('hidden', shared.length > 0); canvas.classList.toggle('hidden', shared.length === 0);
             if (shared.length === 0) return;
             comparisonChart = new Chart(ctx, {
                 type: 'bar',
                 data: { labels: shared.map(h => h.name), datasets: [ { label: state.userNames.user1, data: shared.map(h => h.s1), backgroundColor: 'rgba(99, 102, 241, 0.7)', borderColor: 'rgba(99, 102, 241, 1)', borderWidth: 1 }, { label: state.userNames.user2, data: shared.map(h => h.s2), backgroundColor: 'rgba(34, 197, 94, 0.7)', borderColor: 'rgba(34, 197, 94, 1)', borderWidth: 1 } ] },
                 options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: 'Current Streak (Days)' }, grid: { color: state.theme === 'dark' ? '#30363d' : 'rgba(0,0,0,0.1)' }, ticks: { color: state.theme === 'dark' ? '#bdc6cf' : '#374151' } }, x: { grid: { display: false }, ticks: { color: state.theme === 'dark' ? '#bdc6cf' : '#374151' } } }, plugins: { legend: { labels: { color: state.theme === 'dark' ? '#bdc6cf' : '#374151' } }, tooltip: { mode: 'index', intersect: false } } }
             });
         }
        function renderDashboard() { updateAvatarDisplays(); renderDashboardStats('user1'); renderDashboardStats('user2'); renderDashboardChart(); getEl('comparison-chart-container').classList.toggle('hidden', !comparisonChart); }

        // --- Modal Functions ---
        function openModal(el) { el.classList.remove('hidden'); document.body.style.overflow = 'hidden'; }
        function closeModal(el) { el.classList.add('hidden'); document.body.style.overflow = ''; }
        function openEditHabitsModal() {
             const list = getEl('edit-habits-list'); list.innerHTML = ''; const user = getEl('edit-habits-user-select').value; const habits = state.habits[user] || [];
             if (habits.length === 0) { list.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 py-4">No habits found.</p>`; }
             else {
                 habits.sort((a, b) => a.name.localeCompare(b.name)).forEach(h => { if (!h) return; const s = calculateStreak(h.chain); const b = h.bestStreak || 0; const cN = stringToColorClass(h.category || 'General'); const cV = `--color-${cN}-500`; const btn = document.createElement('button'); btn.className = `w-full text-left bg-gray-50 dark:bg-gray-800 p-3 rounded-lg shadow-sm cursor-pointer border-l-4 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-1 focus:ring-offset-1 ring-offset-white dark:ring-offset-gray-900 focus:ring-${cN}-500`; btn.style.borderLeftColor = `var(${cV}, #6b7280)`; btn.dataset.habitId = h.id; btn.innerHTML = `<div class="flex justify-between items-center"><div><h4 class="font-medium text-gray-800 dark:text-gray-100">${h.name}</h4><span class="text-xs text-gray-500 dark:text-gray-400">${h.category || 'General'}</span></div><span class="text-xs font-mono text-gray-600 dark:text-gray-300">Curr:${s}/Best:${b}</span></div>`; btn.onclick = () => { openEditHabitModal(h.id, user); closeModal(getEl('edit-habits-modal')); }; list.appendChild(btn); });
             }
             openModal(getEl('edit-habits-modal'));
        }
        function openEditHabitModal(habitId, user) {
             const userKey = user || state.currentUser; const idx = state.habits[userKey]?.findIndex(h => h && h.id === habitId); if (idx === -1) { showNotification("Habit not found.", 'error'); return; }
             const h = state.habits[userKey][idx]; const modal = getEl('edit-habit-modal');
             getEl('edit-habit-name').value = h.name; getEl('edit-habit-category').value = h.category || '';
             modal.dataset.habitId = h.id; modal.dataset.habitUser = userKey;
             const chain = h.chain || []; let note = ''; let noteDate = '';
             if (chain.length > 0) { const dateStr = getTodayDateString(); noteKey = `${userKey}-${h.id}-${dateStr}`; note = state.notes[noteKey] || ''; noteDate = dateStr; } // Simplified: Note always for today
             getEl('edit-habit-note').value = note; modal.dataset.noteDate = noteDate;
             renderEditChainContainer(chain); openModal(modal);
        }
        function renderEditChainContainer(chain) {
             const cont = getEl('edit-chain-container'); cont.innerHTML = ''; if (!Array.isArray(chain)) return;
             chain.forEach((day, idx) => { const btn = document.createElement('button'); btn.className = `w-7 h-7 rounded-full flex items-center justify-center text-xs font-medium transition ${day ? 'bg-green-500 hover:bg-green-600 text-white' : 'bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300'}`; btn.textContent = idx + 1; btn.type = 'button'; btn.title = `Day ${idx + 1}`; btn.dataset.index = idx; btn.onclick = () => { const current = JSON.parse(cont.dataset.currentChain || '[]'); current[idx] = !current[idx]; cont.dataset.currentChain = JSON.stringify(current); renderEditChainContainer(current); }; cont.appendChild(btn); });
             cont.dataset.currentChain = JSON.stringify(chain);
        }

        // --- Notifications ---
        function showNotification(message, type = 'info', duration = 3000) {
             const area = getEl('notification-area'); if (!area) return; const notif = document.createElement('div');
             const typeClasses = { success: 'bg-green-500 border-green-600', error: 'bg-red-500 border-red-600', info: 'bg-blue-500 border-blue-600', warning: 'bg-yellow-500 border-yellow-600 text-black' };
             notif.className = `rounded-lg shadow-lg p-3 border-l-4 text-white text-sm ${typeClasses[type] || typeClasses.info} transition-all duration-300 ease-out transform translate-y-2 opacity-0`;
             notif.textContent = message; area.appendChild(notif);
             requestAnimationFrame(() => { notif.style.opacity = '1'; notif.style.transform = 'translateY(0)'; });
             const tId = setTimeout(() => { notif.style.opacity = '0'; notif.style.transform = 'translateX(100%)'; setTimeout(() => notif.remove(), 300); }, duration);
             notif.onclick = () => { clearTimeout(tId); notif.style.opacity = '0'; notif.style.transform = 'translateX(100%)'; setTimeout(() => notif.remove(), 300); };
        }

        // --- Undo Functionality ---
        function showUndo(userId, habitId) {
             clearPendingUndo(); const card = queryEl(`.habit-card[data-habit-id='${habitId}'][data-user-id='${userId}']`); if (!card) return; const btn = card.querySelector('.undo-button'); if (!btn) return;
             state.pendingUndo = { userId, habitId }; btn.classList.add('visible');
             undoTimeoutId = setTimeout(clearPendingUndo, 5000);
        }
        function handleUndoClick(event) {
             event?.stopPropagation(); if (!state.pendingUndo) return; const { userId, habitId } = state.pendingUndo; const idx = state.habits[userId]?.findIndex(h => h && h.id === habitId);
             if (idx !== -1) { const h = state.habits[userId][idx]; if (Array.isArray(h.chain) && h.chain.length > 0) { h.chain.pop(); const today = getTodayDateString(); const key = `${userId}-${habitId}`; if (state.lastTrackedDate[key] === today) delete state.lastTrackedDate[key]; calculateAndUpdateBestStreak(h); saveState(); renderHabits(); showNotification('Last action undone.', 'info'); } }
             clearPendingUndo();
        }
        function clearPendingUndo() {
             if (undoTimeoutId) { clearTimeout(undoTimeoutId); undoTimeoutId = null; }
             if (state.pendingUndo) { const { userId, habitId } = state.pendingUndo; const card = queryEl(`.habit-card[data-habit-id='${habitId}'][data-user-id='${userId}']`); if (card) { const btn = card.querySelector('.undo-button'); if (btn) btn.classList.remove('visible'); } state.pendingUndo = null; }
        }

        // --- Initialization ---
        function initApp() {
            // loadState() is called before setupEventListeners in DOMContentLoaded
            applyTheme();
            displayQuote();
            updateUserDisplayNames();
            updateAvatarDisplays();
            populateCategoryFilterAndSuggestions();

            state.currentView = 'user';
            state.currentUser = (state.habits.user1?.length ?? 0) >= (state.habits.user2?.length ?? 0) ? 'user1' : 'user2';
            updateViewSpecificStyles(); // Renders initial view

            showNotification(`Welcome back!`, 'success', 2000);
        }

        // --- Event Handlers Setup ---
        function setupEventListeners() {
            // Login & Header
            getEl('login-btn').addEventListener('click', handleLogin);
            getEl('pin-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });
            getEl('pin-input').addEventListener('input', () => { if (getEl('pin-input').value.length > 4) getEl('pin-input').value = getEl('pin-input').value.slice(0, 4); });
            getEl('logout-btn').addEventListener('click', handleLogout);
            getEl('theme-toggle').addEventListener('click', toggleTheme);
            getEl('settings-btn').addEventListener('click', () => getEl('settings-panel').classList.add('open'));

            // View Navigation
            getEl('user1-btn').addEventListener('click', () => switchUserView('user1'));
            getEl('user2-btn').addEventListener('click', () => switchUserView('user2'));
            getEl('compare-btn').addEventListener('click', showCompareView);

            // User View
            getEl('add-habit-btn').addEventListener('click', () => getEl('add-habit-form').classList.remove('hidden'));
            getEl('cancel-habit-btn').addEventListener('click', () => { getEl('add-habit-form').classList.add('hidden'); getEl('new-habit-name').value = ''; getEl('new-habit-category').value = ''; });
            getEl('save-habit-btn').addEventListener('click', handleSaveNewHabit);
            getEl('new-habit-name').addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSaveNewHabit(); });
            getEl('category-filter').addEventListener('change', renderHabits);

            // Habits Container (Delegated)
            getEl('habits-container').addEventListener('click', handleHabitCardClick);

            // Settings Panel
            getEl('close-settings-btn').addEventListener('click', () => getEl('settings-panel').classList.remove('open'));
            getEl('dark-mode-toggle').addEventListener('click', toggleTheme);
            getEl('user1-avatar-btn').addEventListener('click', () => getEl('user1-avatar').click());
            getEl('user2-avatar-btn').addEventListener('click', () => getEl('user2-avatar').click());
            getEl('user1-avatar').addEventListener('change', (e) => handleAvatarUpload(e, 'user1'));
            getEl('user2-avatar').addEventListener('change', (e) => handleAvatarUpload(e, 'user2'));
            getEl('save-names-btn').addEventListener('click', handleSaveUserProfiles);
            getEl('edit-habits-btn').addEventListener('click', () => { getEl('settings-panel').classList.remove('open'); getEl('edit-habits-user-select').value = state.currentUser; openEditHabitsModal(); });
            getEl('reset-all-btn').addEventListener('click', () => { getEl('settings-panel').classList.remove('open'); openModal(getEl('reset-confirm-modal')); });
            getEl('reset-pin-btn').addEventListener('click', () => { getEl('settings-panel').classList.remove('open'); openModal(getEl('reset-pin-modal')); getEl('current-pin').value = ''; getEl('new-pin').value = ''; getEl('confirm-new-pin').value = ''; getEl('reset-pin-error').classList.add('hidden'); });

            // Modals
            getEl('edit-habits-user-select').addEventListener('change', openEditHabitsModal);
            getEl('cancel-edit-habits-btn').addEventListener('click', () => closeModal(getEl('edit-habits-modal')));
            getEl('save-edit-habit-btn').addEventListener('click', handleSaveEditedHabit);
            getEl('reset-habit-btn').addEventListener('click', handleResetSingleHabit);
            getEl('delete-habit-btn').addEventListener('click', handleDeleteHabit);
            getEl('cancel-edit-habit-btn').addEventListener('click', () => closeModal(getEl('edit-habit-modal')));
            getEl('confirm-reset-btn').addEventListener('click', handleConfirmResetAll);
            getEl('cancel-reset-btn').addEventListener('click', () => closeModal(getEl('reset-confirm-modal')));
            getEl('confirm-delete-btn').addEventListener('click', handleConfirmDeleteHabit);
            getEl('cancel-delete-btn').addEventListener('click', () => closeModal(getEl('delete-confirm-modal')));
            getEl('confirm-reset-pin-btn').addEventListener('click', handleConfirmResetPin);
            getEl('cancel-reset-pin-btn').addEventListener('click', () => closeModal(getEl('reset-pin-modal')));
            [getEl('current-pin'), getEl('new-pin'), getEl('confirm-new-pin')].forEach(input => { input.addEventListener('input', () => { if (input.value.length > 4) input.value = input.value.slice(0, 4); }); input.addEventListener('keypress', (e) => { if (!/\d/.test(e.key) && !['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab'].includes(e.key)) e.preventDefault(); }); });

            setupModalAndSettingsClosers(); // Generic closers
        }

        function setupModalAndSettingsClosers() {
             queryAllEl('.modal-overlay').forEach(modal => { modal.addEventListener('click', (e) => { if (e.target === modal) { const cb = modal.querySelector('[id^="cancel-"]'); if (cb) cb.click(); else closeModal(modal); } }); });
             document.addEventListener('click', (e) => { const p = getEl('settings-panel'), b = getEl('settings-btn'); if (!p || !b) return; if (p.classList.contains('open') && !p.contains(e.target) && !b.contains(e.target)) p.classList.remove('open'); });
        }

        // --- Event Handlers ---
        function handleLogin() {
            if (getEl('pin-input').value === state.appPin) {
                getEl('pin-error').classList.add('hidden');
                anime({ targets: getEl('login-container'), scale: 0.9, opacity: 0, duration: 300, easing: 'easeInOutQuad',
                    complete: () => { getEl('login-screen').classList.add('opacity-0', 'pointer-events-none'); setTimeout(() => { getEl('login-screen').classList.add('hidden'); getEl('app-container').classList.remove('hidden'); initApp(); }, 300); } });
            } else { getEl('pin-error').classList.remove('hidden'); anime({ targets: getEl('login-container'), translateX: [{ value: -6 }, { value: 6 }, { value: -4 }, { value: 4 }, { value: 0 }], duration: 300, easing: 'easeInOutSine' }); }
        }
        function handleLogout() { if (!confirm("Log out?")) return; getEl('app-container').classList.add('hidden'); getEl('login-screen').classList.remove('hidden', 'opacity-0', 'pointer-events-none'); getEl('pin-input').value = ''; getEl('pin-error').classList.add('hidden'); anime({ targets: getEl('login-container'), scale: [0.95, 1], opacity: [0, 1], duration: 300, easing: 'easeOutQuad' }); }
        function toggleTheme() { state.theme = (state.theme === 'light') ? 'dark' : 'light'; applyTheme(); saveState(); }
        function switchUserView(userId) { clearPendingUndo(); state.currentUser = userId; state.currentView = 'user'; updateUserDisplayNames(); updateAvatarDisplays(); updateViewSpecificStyles(); }
        function showCompareView() { clearPendingUndo(); state.currentView = 'compare'; updateViewSpecificStyles(); }

        function handleSaveNewHabit() {
            const nameInput = getEl('new-habit-name'); const catInput = getEl('new-habit-category');
            const name = nameInput.value.trim(); let cat = catInput.value.trim() || 'General';
            if (!name) { showNotification("Habit name required.", 'warning'); return; }
            const habits = state.habits[state.currentUser]; if (habits.some(h => h.name.toLowerCase() === name.toLowerCase())) { showNotification(`Habit "${name}" already exists.`, 'warning'); return; }
            const newHabit = { id: Date.now(), name, chain: [], category: cat, bestStreak: 0 };
            habits.push(newHabit); updateCategoriesFromHabits(); populateCategoryFilterAndSuggestions(); saveState(); renderHabits();
            nameInput.value = ''; catInput.value = ''; getEl('add-habit-form').classList.add('hidden');
            showNotification(`Habit "${name}" added!`, 'success');
            const card = queryEl(`.habit-card[data-habit-id="${newHabit.id}"]`); if (card) { card.scrollIntoView({ behavior: 'smooth', block: 'center' }); try { anime({ targets: card, backgroundColor: state.theme === 'dark' ? ['#1f2937', '#161b22'] : ['#ecfdf5', '#ffffff'], duration: 1500 }); } catch(e){} }
        }
        function handleHabitCardClick(event) {
            const trackBtn = event.target.closest('.track-btn'); const undoBtn = event.target.closest('.undo-button');
            if (undoBtn && state.pendingUndo && parseInt(undoBtn.dataset.habitId) === state.pendingUndo.habitId) { handleUndoClick(event); return; }
            if (trackBtn && !trackBtn.disabled) {
                clearPendingUndo(); const habitId = parseInt(trackBtn.dataset.habitId); const userId = state.currentUser; const idx = state.habits[userId]?.findIndex(h => h?.id === habitId); if (idx === -1) return;
                if (hasTrackedToday(userId, habitId)) return;
                const h = state.habits[userId][idx]; if (!Array.isArray(h.chain)) h.chain = [];
                const oldStreak = calculateStreak(h.chain); // Calculate before adding
                h.chain.push(true); // Add day
                const newStreak = oldStreak + 1; // New current streak
                h.bestStreak = Math.max(h.bestStreak || 0, newStreak); // Update best if needed
                state.lastTrackedDate[`${userId}-${habitId}`] = getTodayDateString();
                saveState(); showUndo(userId, habitId); renderHabits();
                if (typeof confetti === 'function') { const r = trackBtn.getBoundingClientRect(); confetti({ particleCount: 50, spread: 50, origin: { x: (r.left + r.width / 2) / window.innerWidth, y: (r.top + r.height / 2) / window.innerHeight }, zIndex: 50 }); }
            }
        }
        function handleAvatarUpload(event, userKey) {
            const file = event.target.files[0]; const preview = getEl(userKey === 'user1' ? 'settings-user1-avatar-preview' : 'settings-user2-avatar-preview');
            if (file && file.type.startsWith('image/')) { if (file.size > 2097152) { showNotification("Max 2MB image size.", 'warning'); event.target.value = ''; return; } const reader = new FileReader(); reader.onload = (e) => { state.userAvatars[userKey] = e.target.result; preview.src = e.target.result; }; reader.onerror = () => showNotification("Error reading image.", 'error'); reader.readAsDataURL(file); } else if (file) { showNotification("Invalid image file.", 'warning'); event.target.value = ''; }
        }
        function handleSaveUserProfiles() { state.userNames.user1 = getEl('user1-name').value.trim() || 'User 1'; state.userNames.user2 = getEl('user2-name').value.trim() || 'User 2'; saveState(); updateUserDisplayNames(); updateAvatarDisplays(); if (state.currentView === 'compare') renderDashboard(); if (state.currentView === 'user') renderHabits(); showNotification('Profiles saved!', 'success'); getEl('settings-panel').classList.remove('open'); }
        function handleSaveEditedHabit() {
             const modal = getEl('edit-habit-modal'); const id = parseInt(modal.dataset.habitId); const user = modal.dataset.habitUser; const idx = state.habits[user]?.findIndex(h => h?.id === id); if (idx === -1) { showNotification("Error saving.", 'error'); closeModal(modal); return; }
             const name = getEl('edit-habit-name').value.trim(); let cat = getEl('edit-habit-category').value.trim() || 'General'; const chain = JSON.parse(getEl('edit-chain-container').dataset.currentChain || '[]'); const note = getEl('edit-habit-note').value.trim(); const noteDate = modal.dataset.noteDate;
             if (!name) { showNotification("Name required.", 'warning'); return; }
             if (state.habits[user].some(h => h && h.id !== id && h.name.toLowerCase() === name.toLowerCase())) { showNotification(`"${name}" already exists.`, 'warning'); return; }
             const h = state.habits[user][idx]; h.name = name; h.category = cat; h.chain = chain; h.bestStreak = calculateAndUpdateBestStreak(h);
             if (noteDate) { const key = `${user}-${id}-${noteDate}`; if (note) state.notes[key] = note; else delete state.notes[key]; } else { getEl('edit-habit-note').value = ''; } // Clear note field if no date
             updateCategoriesFromHabits(); populateCategoryFilterAndSuggestions(); saveState(); closeModal(modal); updateViewSpecificStyles(); showNotification(`"${name}" updated.`, 'success');
        }
        function handleResetSingleHabit() { if (!confirm("Reset chain for this habit?")) return; const modal = getEl('edit-habit-modal'); const chain = []; renderEditChainContainer(chain); getEl('edit-chain-container').dataset.currentChain = JSON.stringify(chain); showNotification('Chain reset in editor. Save to confirm.', 'info'); }
        function handleDeleteHabit() { const modal = getEl('edit-habit-modal'); const id = parseInt(modal.dataset.habitId); const user = modal.dataset.habitUser; const idx = state.habits[user]?.findIndex(h => h?.id === id); if (idx === -1) return; getEl('delete-habit-name-confirm').textContent = state.habits[user][idx].name; getEl('delete-confirm-modal').dataset.habitId = id; getEl('delete-confirm-modal').dataset.habitUser = user; closeModal(modal); openModal(getEl('delete-confirm-modal')); }
        function handleConfirmDeleteHabit() { const modal = getEl('delete-confirm-modal'); const id = parseInt(modal.dataset.habitId); const user = modal.dataset.habitUser; if (state.habits[user]) state.habits[user] = state.habits[user].filter(h => h?.id !== id); Object.keys(state.notes).filter(k => k.startsWith(`${user}-${id}-`)).forEach(k => delete state.notes[k]); updateCategoriesFromHabits(); populateCategoryFilterAndSuggestions(); saveState(); closeModal(modal); updateViewSpecificStyles(); showNotification("Habit deleted.", 'success'); }
        function handleConfirmResetAll() { Object.keys(state.habits).forEach(user => { if (Array.isArray(state.habits[user])) state.habits[user].forEach(h => { if (h) { h.chain = []; h.bestStreak = 0; } }); }); state.lastTrackedDate = {}; state.notes = {}; saveState(); closeModal(getEl('reset-confirm-modal')); updateViewSpecificStyles(); showNotification("All data reset.", 'success'); }
        function handleConfirmResetPin() { const cur = getEl('current-pin').value; const n1 = getEl('new-pin').value; const n2 = getEl('confirm-new-pin').value; const err = getEl('reset-pin-error'); err.classList.add('hidden'); if (cur !== state.appPin) { err.textContent = 'Current PIN incorrect.'; err.classList.remove('hidden'); return; } if (!/^\d{4}$/.test(n1)) { err.textContent = 'New PIN must be 4 digits.'; err.classList.remove('hidden'); return; } if (n1 === cur) { err.textContent = 'New PIN must be different.'; err.classList.remove('hidden'); return; } if (n1 !== n2) { err.textContent = 'New PINs do not match.'; err.classList.remove('hidden'); return; } state.appPin = n1; saveState(); closeModal(getEl('reset-pin-modal')); showNotification("PIN changed!", 'success'); }

        // --- Run ---
        document.addEventListener('DOMContentLoaded', () => {
            try {
                loadState();
                applyTheme();
                setupEventListeners();
                // Show login screen
                getEl('login-screen').classList.remove('hidden');
                anime({ targets: getEl('login-container'), scale: [0.95, 1], opacity: [0, 1], duration: 400, easing: 'easeOutExpo' });
            } catch (error) {
                console.error("Initialization Error:", error);
                document.body.innerHTML = `<div style="padding: 20px; text-align: center; color: red; font-family: sans-serif;">App failed to initialize. Please check the console (F12) for errors and try refreshing.</div>`;
            }
        });

    </script>

</body>
</html>